import{G as ut,f as rt,w as W,o as K,b as x,i as c,h as st,x as it,H as lt,u as i,z as dt,F as Q,s as X,t as S,j as H,q as mt,k as ht,e as b,v as tt,C as ft,D as pt,I as _t,a as yt}from"./entry.18113fa8.js";import{P as At,U as St,l as G,_ as wt}from"./url.7325f4a5.js";import{u as Bt}from"./stakeholder.099323d5.js";import{a as w,B as et}from"./types.3d83ab55.js";import{u as vt}from"./hauptbuch.29779dd8.js";import{u as Et}from"./accounts.c046b172.js";const Pt=e=>new Promise(function(_,u){At.parse(e,{download:!0,header:!0,skipEmptyLines:!0,complete:_,error:u})}),Kt="/gviz/tq?tqx=out:csv",xt="&sheet=perioden",Lt=St+Kt+xt,ct=ut("perioden",{state:()=>({_perioden:[],_currentPeriod:""}),actions:{async loadDataFromGoogle(){const e=await Pt(Lt);this._perioden=e.data,this._currentPeriod=this._perioden[0].Periode},setPeriod(e){this._currentPeriod=e}},getters:{reparaturpauschale:e=>p=>e._perioden.find(_=>_.Periode===p).Reparaturpauschale,listOfPeriods:e=>e._perioden.map(p=>p.Periode),currentPeriod:e=>e._currentPeriod}}),Nt={id:"my-global"},zt=rt({__name:"YearSwitch",async setup(e){let p,_;const u=ct();[p,_]=W(()=>u.loadDataFromGoogle()),await p,_();const t=u.listOfPeriods;let L=u.currentPeriod;const f=()=>{G(`


changeFinancialYear`,L),u.setPeriod(L)};return(B,n)=>(K(),x("form",Nt,[c("span",null,[st("Welches Jahr möchtest du sehen?"),it(c("select",{"onUpdate:modelValue":n[0]||(n[0]=z=>dt(L)?L.value=z:L=z),onChange:n[1]||(n[1]=z=>f())},[(K(!0),x(Q,null,X(i(t),z=>(K(),x("option",null,S(z),1))),256))],544),[[lt,i(L)]])])]))}}),v=(e,p,_)=>{if(e===null)return;const u=new w(e.nr,e.date,e.soll,e.haben,e.description,e.kmStart),t=new w(e.nr,e.date,e.haben,e.soll,e.description,e.kmStart);p.bookings.push(u),_.bookings.push(t)},kt=e=>e.key.indexOf("an: ")===0,Ft=e=>e.key.indexOf("Jahresbeitrag")===0,Z=e=>+(e.kmSinceLastFuelFill||"0")!=0||"Tanken".indexOf(e.description)>0,nt=e=>e.toFixed(2).replace(".",",")+" €",Ct=e=>Math.round(e*100)/100,A=e=>typeof e=="string"?parseFloat(e.replaceAll(".","").replace("€","").trim().replace(",",".")):Number.isNaN(e)?0:e,Ot=e=>Z(e)?+e.liters.replace("l","").trim().replace(",","."):0;let J=0,R=0;const Mt=(e,p,_,u)=>{for(var t of p){let f=!1;const B=_.shVerteilung(t.account).split(",");B.length>1;for(var L of B){const n=L.trim();if(!e.findAccount(n,"Konto 1")){G("Error: Konto nicht gefunden: ",n,t);const r=e.findAccount("System","Errors"),o=e.findAccount("System","Errors1"),s="Konto "+n+" nicht gefunden",d=new w(t.nr,t.date,0,A(t.amount),s,+t.km);v(d,r,o),f=!0}if(Ft(t)){const r=e.findAccount("Bussi","Konto 1"),o=e.findAccount(n,"Konto 1"),s=A(t.amount)/B.length,d=t.account+" Jahresbeitrag "+t.description+" "+s+" "+t.amount,h=new w(t.nr,t.date,0,s,d,+t.km);v(h,r,o),f=!0}if(kt(t)){const r=e.findAccount(n,"Ausgleichskonto"),o=e.findAccount(t.key.slice(4),"Ausgleichskonto"),s=A(t.amount)/B.length,d=t.account+" Ausgleichsbuchung an "+t.key.slice(4)+" "+s,h=new w(t.nr,t.date,0,s,d,+t.km-+(t.kmSinceLastEntry||"0"));v(h,r,o),f=!0,G("bookEverythingtoBS: ausgleichbuchung gefunden ",t.key,t.key.slice(4),r,o,h)}if(Z(t)&&(A(t.fuelPriceInEuro)&&(J=Math.round(1e3*A(t.fuelPriceInEuro))/1e3),t.consumption&&+t.consumption!=0&&(R=Math.round(100*t.consumption)/100,R<8||R>11))){const r=e.findAccount("System","Errors"),o=e.findAccount("System","Errors1"),s="falscher Verbrauchswert:   "+R+"  Liter/100km<br>"+t.account+" Verbrauch "+t.description+" <br> amount:"+t.amount+" "+A(t.amount)+"<br> kmSinceLastEntry:"+t.kmSinceLastEntry+"<br> splits:"+B+"<br> booking:"+JSON.stringify(t),d=new w(t.nr,t.date,0,A(t.amount),s,+t.km);v(d,r,o)}if((r=>+r.key>0||r.key.indexOf("Reparatur")>-1)(t)){const r=e.findAccount(n,"Konto 3"),o=e.findAccount("Bussi","Konto 3"),s=A(t.amount)/B.length,d=t.account+" Reparatur "+t.description+" "+s+" "+t.amount,h=new w(t.nr,t.date,0,s,d,+t.km-+(t.kmSinceLastEntry||"0"));v(h,r,o),f=!0}if((r=>parseFloat(r.kmSinceLastEntry+"")!=0)(t)){const r=e.findAccount(n,"Kilometer"),o=e.findAccount("Bussi","Kilometer"),s=parseFloat(t.kmSinceLastEntry||"0")/B.length,h=+t.km-parseFloat(t.kmSinceLastEntry||"0"),M=Math.round(J*s*R)/100,F=Math.round(100*+u.reparaturpauschale(u.currentPeriod).replace(",",".")*s)/100,V=t.account+" Kilometer "+s+" von "+t.kmSinceLastEntry+" km, "+n+"-->Bussi "+t.description+"<br>Benzingeld: "+M+" €, Reparaturgeld: "+F+" € für "+s+" km",a=new w(t.nr,t.date,s,0,V,h);v(a,r,o),f=!0;const E=e.findAccount(n,"Konto 2"),C=e.findAccount("Bussi","Konto 2"),k="Benzingeld: "+n+"-->Bussi, "+M+" € für "+s+" km, Benzinpreis: "+J+"€/L, Verbrauch: "+R+" ="+Math.round(J*R)/100+"€/km",m=new w(t.nr,t.date,M,0,k,h);v(m,E,C);const y=e.findAccount("Bussi","Konto 3"),I=e.findAccount(n,"Konto 3"),P=new w(t.nr,t.date,0,F,"Reparaturpauschale "+u.reparaturpauschale(u.currentPeriod)+" €/km * "+s+" km = "+F+" € : "+n+" --> Bussi",h);v(P,y,I)}if(Z(t)){const r=Math.round(100*A(t.amount))/100,o=e.findAccount("Bussi","Konto 2"),s=e.findAccount(n,"Konto 2"),d=t.account+": Tanken für "+r+"€, "+Ot(t)+" Liter, <br> Verbrauch: "+R+" l/100km, <br>"+n+"-->Bussi<br>Benzinpreis: "+J+" €/l",h=A(t.amount)/B.length,F=+t.km-parseFloat(t.kmSinceLastEntry||"0"),V=new w(t.nr,t.date,h,0,d,F);v(V,o,s),f=!0}if((r=>r.key==="gleich")(t)){const r=e.findAccount(n,"Konto 1"),o=e.findAccount("Bussi","Konto 1"),s=A(t.amount)/B.length,d=t.account+" Konto 1 "+t.description+" "+s+" "+t.amount,h=new w(t.nr,t.date,0,s,d,+t.km);v(h,r,o),f=!0}const N=r=>{const o=t&&t.key&&typeof t.key=="string"&&t.key.split(" ").length>0?t.key.split(" ")[1]:"";return r.key.split(" ")[0]==="an"&&o!==""&&(o==="Bussi"||_.personen.indexOf(o)>=0)};if(N(t)){const r=e.findAccount(n,"Ausgleichskonto"),o=t.key.split(" ")[1],s=e.findAccount(o,"Ausgleichskonto"),d=t.account+"-->"+o+": "+t.description+" "+A(t.amount)+" "+t.amount,h=new w(t.nr,t.date,0,A(t.amount),d,+t.km);v(h,r,s),f=!0}if((r=>r.key.toLowerCase()==="jahresendbuchung")(t)){const r=t.description.match("[A-Za-z0-9_.]*:[A-Za-z0-9_.]*.[0-9]* -> [A-Za-z0-9_.]*:[A-Za-z0-9_.]*.[0-9]*"),o=r?r[0]:"";if(o==="")return e;const s=o.split(" -> ")[0].split(":")[0],d=o.split(" -> ")[1].split(":")[0],h=o.split(" -> ")[0].split(":")[1],M=o.split(" -> ")[1].split(":")[1],F=e.findAccount(s,h),V=e.findAccount(d,M),a=new w(t.nr,t.date,A(t.amount),0,t.description,+t.km);v(a,F,V),f=!0}if(A(t.amount)===0&&+(t.kmSinceLastEntry||"0")==0&&(f=!0,G("Nullbuchung ignoriert: "+t+"  km:"+t.kmSinceLastEntry+" €:"+t.amount)),!f){G("Fehler: ",t,N(t));const r=e.findAccount("System","Errors"),o=e.findAccount("System","Errors1"),s=t.account+" Konto 1 "+t.description+" <br> amount:"+t.amount+" "+A(t.amount)+"<br> kmSinceLastEntry:"+t.kmSinceLastEntry+"<br> splits:"+B+"<br> booking:"+JSON.stringify(t),d=new w(t.nr,t.date,0,A(t.amount),s,+t.km);v(d,r,o)}}}return e},O=e=>(ft("data-v-fbb80a15"),e=e(),pt(),e),gt={key:0},Rt=O(()=>c("div",null," ",-1)),Vt={key:1},Gt={class:"center"},It={key:0},Tt={key:2},Dt=["onClick"],Yt={class:"inner",style:{width:"100%"}},$t=O(()=>c("th",{class:"inner"},"Kontobezeichnung ",-1)),Jt=O(()=>c("th",{class:"innter"},"#Buchungen",-1)),Ut=O(()=>c("th",{class:"inner"},"Saldo ",-1)),jt=O(()=>c("th",{class:"inner grey"},"Soll",-1)),Ht=O(()=>c("th",{class:"inner grey"},"Haben",-1)),Wt={class:"inner"},Zt={class:"inner"},qt=["onClick"],Qt=O(()=>c("span",null,"     ",-1)),Xt={class:"inner"},bt={class:"inner"},te={class:"inner grey"},ee={class:"inner grey"},ne=O(()=>c("br",null,null,-1)),re=O(()=>c("br",null,null,-1)),se=rt({__name:"balance",async setup(e){let p,_;const u=H({bookings:[],name:""}),t=a=>{const E=a.bookings;u.bookings.splice(0,u.bookings.length),u.bookings.push(...E),u.name=a.owner+" "+a.name},L=()=>{u.bookings=[],u.name=""};mt(()=>{window.addEventListener("keydown",a=>{a.key==="Enter"&&a.metaKey&&L()})});const f=Bt();[p,_]=W(()=>f.loadStakeholder()),await p,_();const B=f.stakeholder.filter(a=>a.Verteilung.indexOf(",")===-1).map(a=>a.Verteilung),n=ct();[p,_]=W(()=>n.loadDataFromGoogle()),await p,_(),G("balance.currentPeriod ",n.currentPeriod,n);const z=vt(),T=Et();[p,_]=W(()=>T.loadDataFromGoogle()),await p,_(),T.accountBezeichnungen;const q=T.accountNames;let N=H(z.bookings),l=H(new et(B,q,N));l.findAccount("System","Errors");const r=_t();ht(n.$state,async(a,E)=>{await z.loadBussiData(n.currentPeriod),N=H(z.bookings),l=new et(B,q,N),l=Mt(l,N,f,n),l=F(l,N,f,n),l=V(l,N,f,n),r&&r.proxy&&r.proxy.$forceUpdate(),u.bookings=[],u.name=""});const o=()=>l.findAccount("Bussi","Kilometer").saldoY(n.currentPeriod),s=()=>Math.round(N.reduce((a,E)=>a+M(E),0)),d=()=>Math.round(100*s()*2.37/1e3)/100,h=()=>Math.round(s()/o()*1e4)/100,M=a=>Z(a)?+a.liters.replace("l","").trim().replace(",","."):0;G("bs after bookEverythingtoBS",l);const F=(a,E,C,k)=>{const m=a.findAccount("Bussi","Konto 1"),y=Ct(-m.saldoY(k.currentPeriod)/C.personen.length);if(y===0)return a;for(var I of C.personen){const P=a.findAccount(I,"Konto 1"),g=new w("9999",k.currentPeriod+"-12-31",y,0,"Ausgleichsbuchung Konto1 "+k.currentPeriod+" "+P.owner+":"+P.name+" -> "+m.owner+":"+m.name);v(g,P,m)}return a},V=(a,E,C,k)=>{const m=a.saldierenEuro("Bussi"),y=C.personen.map(P=>{const g=a.saldierenEuro(P)+m/C.personen.length;return{name:P,saldo:g}});let I=100;for(;I-- >0;){const P=y.reduce((Y,$)=>Y.saldo<$.saldo?Y:$),g=y.reduce((Y,$)=>Y.saldo>$.saldo?Y:$);if(P.saldo>=.01||g.saldo<=.01)break;const D=Math.min(-P.saldo,g.saldo),U=a.findAccount(g.name,"Ausgleichskonto"),j=a.findAccount(P.name,"Ausgleichskonto"),ot="Ausgleichsbuchung Salden <br>"+k.currentPeriod+" "+U.owner+":"+U.name+" -> "+j.owner+":"+j.name+"<br>Amount: "+nt(D)+"<br>konkret:  "+U.owner+" bekommt "+nt(D)+" von "+j.owner,at=new w("9999",k.currentPeriod+"-12-31",D,0,ot);v(at,U,j),P.saldo+=D,g.saldo-=D}return a};return(a,E)=>{const C=zt,k=wt;return K(),x("div",null,[b(C),c("h1",null,"Bilanz: "+S(i(n).currentPeriod)+", "+S(i(N).length)+" Buchungen ",1),i(l).findAccount("Bussi","Errors").bookings.length>0?(K(),x("div",gt,[c("a",{class:"errors",href:"#",onClick:E[0]||(E[0]=m=>t(i(l).findAccount("Bussi","Errors")))}," Errors: "+S(i(l).findAccount("Bussi","Errors").bookings.length),1)])):tt("",!0),c("div",null,"Kilometer: "+S(o())+" km",1),c("div",null,"Benzin: "+S(s())+" Liter",1),c("div",null,"CO2: "+S(d())+" Tonnen CO2 ",1),c("div",null,"Verbrauch: "+S(h())+" Liter/100km",1),c("div",null,"Reparaturpauschale: "+S(i(n).reparaturpauschale(i(n).currentPeriod))+"€",1),Rt,u.bookings.length!=0?(K(),x("div",Vt,[c("div",Gt,[c("button",{class:"green",onClick:E[1]||(E[1]=m=>L())},"hit ⌘+<Enter> to go back"),u.bookings.length>0?(K(),x("div",It)):tt("",!0),b(k,{selectedBookingsToRender:u.bookings,konto:u.name},null,8,["selectedBookingsToRender","konto"])])])):(K(),x("div",Tt,[c("table",null,[(K(!0),x(Q,null,X(i(B),m=>(K(),x("tr",null,[c("td",null,[st(S(m),1),c("a",{href:"#",onClick:y=>t(i(l).findAccount(m,"Kilometer"))},[c("div",null,"Kilometer: "+S(Math.abs(i(l).findAccount(m,"Kilometer").saldoY(i(n).currentPeriod)))+" km",1)],8,Dt),c("div",null,[c("b",null,"Saldo: "+S(i(l).saldierenEuro(m))+" €",1)])]),c("td",null,[c("table",Yt,[$t,Jt,Ut,jt,Ht,(K(!0),x(Q,null,X(i(T).accounts.filter(y=>y.Name!=="Kilometer"&&(y.Name!=="Konto 9000"||m==="Bussi")),y=>(K(),x("tr",Wt,[c("td",Zt,[c("a",{href:"#",onClick:I=>t(i(l).findAccount(m,y.Name))},[c("span",null,S(y.Bezeichnung),1)],8,qt),Qt]),c("td",Xt,S(i(l).findAccount(m,y.Name).bookings.length),1),c("td",bt,S(i(l).findAccount(m,y.Name).saldoY(i(n).currentPeriod))+" €",1),c("td",te,S(i(l).findAccount(m,y.Name).saldoSoll(i(n).currentPeriod))+" €",1),c("td",ee,S(i(l).findAccount(m,y.Name).saldoHaben(i(n).currentPeriod))+" € ",1)]))),256))])])]))),256))])])),ne,re])}}});const de=yt(se,[["__scopeId","data-v-fbb80a15"]]);export{de as default};
