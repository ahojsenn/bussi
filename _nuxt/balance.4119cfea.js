import{G as ut,f as rt,w as Z,o as k,b as x,i as r,h as st,x as it,H as lt,u as l,z as dt,F as Q,s as X,t as A,j as W,q as mt,k as pt,e as b,v as tt,C as ht,D as ft,I as _t,a as yt}from"./entry.ca4602c4.js";import{P as At,U as St,l as I,_ as vt}from"./url.b9dc0265.js";import{u as wt}from"./stakeholder.ce17e159.js";import{a as S,B as et}from"./types.3d83ab55.js";import{u as Bt}from"./hauptbuch.5a29f5cd.js";import{u as Pt}from"./accounts.b910d534.js";const Et=e=>new Promise(function(p,u){At.parse(e,{download:!0,header:!0,skipEmptyLines:!0,complete:p,error:u})}),kt="/gviz/tq?tqx=out:csv",xt="&sheet=perioden",Kt=St+kt+xt,ot=ut("perioden",{state:()=>({_perioden:[],_currentPeriod:""}),actions:{async loadDataFromGoogle(){const e=await Et(Kt);this._perioden=e.data,this._currentPeriod=this._perioden[0].Periode},setPeriod(e){this._currentPeriod=e}},getters:{reparaturpauschale:e=>m=>e._perioden.find(p=>p.Periode===m).Reparaturpauschale,listOfPeriods:e=>e._perioden.map(m=>m.Periode),currentPeriod:e=>e._currentPeriod}}),gt={id:"my-global"},Lt=rt({__name:"YearSwitch",async setup(e){let m,p;const u=ot();[m,p]=Z(()=>u.loadDataFromGoogle()),await m,p();const t=u.listOfPeriods;let g=u.currentPeriod;const f=()=>{u.setPeriod(g)};return(v,n)=>(k(),x("form",gt,[r("span",null,[st("Welches Jahr möchtest du sehen?"),it(r("select",{"onUpdate:modelValue":n[0]||(n[0]=L=>dt(g)?g.value=L:g=L),onChange:n[1]||(n[1]=L=>f())},[(k(!0),x(Q,null,X(l(t),L=>(k(),x("option",null,A(L),1))),256))],544),[[lt,l(g)]])])]))}}),E=(e,m,p)=>{if(e===null)return;const u=new S(e.nr,e.date,e.soll,e.haben,e.description,e.kmStart),t=new S(e.nr,e.date,e.haben,e.soll,e.description,e.kmStart);m.bookings.push(u),p.bookings.push(t)},zt=e=>e.key.indexOf("an: ")===0,q=e=>+(e.kmSinceLastFuelFill||"0")!=0||"Tanken".indexOf(e.description)>0,nt=e=>e.toFixed(2).replace(".",",")+" €",Nt=e=>Math.round(e*100)/100,P=e=>typeof e=="string"?parseFloat(e.replaceAll(".","").replace("€","").trim().replace(",",".")):Number.isNaN(e)?0:e,Ct=e=>q(e)?+e.liters.replace("l","").trim().replace(",","."):0;let Y=0,U=0;const Ft=(e,m,p,u)=>{I("bookEverythingtoBS: ",u.currentPeriod);for(var t of m){let f=!1;const v=p.shVerteilung(t.account).split(",");v.length>1;for(var g of v){const n=g.trim();if(zt(t)){const s=e.findAccount(n,"Ausgleichskonto"),c=e.findAccount(t.key.slice(4),"Ausgleichskonto"),a=P(t.amount)/v.length,y=t.account+" Ausgleichsbuchung an "+t.key.slice(4)+" "+a,h=new S(t.nr,t.date,0,a,y,+t.km-+(t.kmSinceLastEntry||"0"));E(h,s,c),f=!0,I("bookEverythingtoBS: ausgleichbuchung gefunden ",t.key,t.key.slice(4),s,c,h)}if(q(t)&&(P(t.fuelPriceInEuro)&&(Y=Math.round(1e3*P(t.fuelPriceInEuro))/1e3),t.consumption&&+t.consumption!=0&&(U=Math.round(100*t.consumption)/100)),(s=>+s.key>0||s.key.indexOf("Reparatur")>-1)(t)){const s=e.findAccount(n,"Konto 3"),c=e.findAccount("Bussi","Konto 3"),a=P(t.amount)/v.length,y=t.account+" Reparatur "+t.description+" "+a+" "+t.amount,h=new S(t.nr,t.date,0,a,y,+t.km-+(t.kmSinceLastEntry||"0"));E(h,s,c),f=!0}if((s=>parseFloat(s.kmSinceLastEntry+"")!=0)(t)){const s=e.findAccount(n,"Kilometer"),c=e.findAccount("Bussi","Kilometer"),a=parseFloat(t.kmSinceLastEntry||"0")/v.length,h=+t.km-parseFloat(t.kmSinceLastEntry||"0"),F=Math.round(Y*a*U)/100,N=Math.round(100*+u.reparaturpauschale(u.currentPeriod).replace(",",".")*a)/100,R=t.account+" Kilometer "+a+" von "+t.kmSinceLastEntry+" km, "+n+"-->Bussi "+t.description+"<br>Benzingeld: "+F+" €, Reparaturgeld: "+N+" € für "+a+" km",o=new S(t.nr,t.date,a,0,R,h);E(o,s,c),f=!0;const w=e.findAccount(n,"Konto 2"),C=e.findAccount("Bussi","Konto 2"),z="Benzingeld: "+n+"-->Bussi, "+F+" € für "+a+" km, Benzinpreis: "+Y+"€/L, Verbrauch: "+U+" ="+Math.round(Y*U)/100+"€/km",d=new S(t.nr,t.date,F,0,z,h);E(d,w,C);const _=e.findAccount("Bussi","Konto 3"),G=e.findAccount(n,"Konto 3"),B=new S(t.nr,t.date,0,N,"Reparaturpauschale "+u.reparaturpauschale(u.currentPeriod)+" €/km * "+a+" km = "+N+" € : "+n+" --> Bussi",h);E(B,_,G)}if(q(t)){const s=Math.round(100*P(t.amount))/100,c=e.findAccount("Bussi","Konto 2"),a=e.findAccount(n,"Konto 2"),y=t.account+": Tanken für "+s+"€, "+Ct(t)+" Liter, <br> Verbrauch: "+U+" l/100km, <br>"+n+"-->Bussi<br>Benzinpreis: "+Y+" €/l",h=P(t.amount)/v.length,N=+t.km-parseFloat(t.kmSinceLastEntry||"0"),R=new S(t.nr,t.date,h,0,y,N);E(R,c,a),f=!0}if((s=>s.key==="gleich")(t)){const s=e.findAccount(n,"Konto 1"),c=e.findAccount("Bussi","Konto 1"),a=P(t.amount)/v.length,y=t.account+" Konto 1 "+t.description+" "+a+" "+t.amount,h=new S(t.nr,t.date,0,a,y,+t.km);E(h,s,c),f=!0}const K=s=>{const c=t&&t.key&&typeof t.key=="string"&&t.key.split(" ").length>0?t.key.split(" ")[1]:"";return s.key.split(" ")[0]==="an"&&c!==""&&(c==="Bussi"||p.personen.indexOf(c)>=0)};if(K(t)){const s=e.findAccount(n,"Ausgleichskonto"),c=t.key.split(" ")[1],a=e.findAccount(c,"Ausgleichskonto"),y=t.account+"-->"+c+": "+t.description+" "+P(t.amount)+" "+t.amount,h=new S(t.nr,t.date,0,P(t.amount),y,+t.km);E(h,s,a),f=!0}if((s=>s.key.toLowerCase()==="jahresendbuchung")(t)){const s=t.description.match("[A-Za-z0-9_.]*:[A-Za-z0-9_.]*.[0-9]* -> [A-Za-z0-9_.]*:[A-Za-z0-9_.]*.[0-9]*"),c=s?s[0]:"";if(c==="")return e;const a=c.split(" -> ")[0].split(":")[0],y=c.split(" -> ")[1].split(":")[0],h=c.split(" -> ")[0].split(":")[1],F=c.split(" -> ")[1].split(":")[1],N=e.findAccount(a,h),R=e.findAccount(y,F),o=new S(t.nr,t.date,P(t.amount),0,t.description,+t.km);E(o,N,R),f=!0}if(P(t.amount)===0&&+(t.kmSinceLastEntry||"0")==0&&(f=!0,I("Nullbuchung ignoriert: "+t+"  km:"+t.kmSinceLastEntry+" €:"+t.amount)),!f){I("Fehler: ",t,K(t));const s=e.findAccount("System","Errors"),c=e.findAccount("System","Errors1"),a=t.account+" Konto 1 "+t.description+" <br> amount:"+t.amount+" "+P(t.amount)+"<br> kmSinceLastEntry:"+t.kmSinceLastEntry+"<br> splits:"+v+"<br> booking:"+JSON.stringify(t),y=new S(t.nr,t.date,0,P(t.amount),a,+t.km);E(y,s,c)}}}return e},O=e=>(ht("data-v-69cff240"),e=e(),ft(),e),Mt={key:0},Ot=O(()=>r("div",null," ",-1)),Rt={key:1},Gt={class:"center"},It={key:0},Tt={key:2},Vt=["onClick"],Dt={class:"inner",style:{width:"100%"}},$t=O(()=>r("th",{class:"inner"},"Kontobezeichnung ",-1)),Yt=O(()=>r("th",{class:"inner"},"Saldo ",-1)),Ut=O(()=>r("th",{class:"inner grey"},"Soll",-1)),jt=O(()=>r("th",{class:"inner grey"},"Haben",-1)),Ht={class:"inner"},Wt={class:"inner"},Zt=["onClick"],qt=O(()=>r("span",null,"     ",-1)),Jt={class:"inner"},Qt={class:"inner grey"},Xt={class:"inner grey"},bt=O(()=>r("br",null,null,-1)),te=O(()=>r("br",null,null,-1)),ee=rt({__name:"balance",async setup(e){let m,p;const u=W({bookings:[],name:""}),t=o=>{const w=o.bookings;u.bookings.splice(0,u.bookings.length),u.bookings.push(...w),u.name=o.owner+" "+o.name},g=()=>{u.bookings=[],u.name=""};mt(()=>{window.addEventListener("keydown",o=>{o.key==="Enter"&&o.metaKey&&g()})});const f=wt();[m,p]=Z(()=>f.loadStakeholder()),await m,p();const v=f.stakeholder.filter(o=>o.Verteilung.indexOf(",")===-1).map(o=>o.Verteilung),n=ot();[m,p]=Z(()=>n.loadDataFromGoogle()),await m,p(),I("balance.currentPeriod ",n.currentPeriod,n);const L=Bt(),T=Pt();[m,p]=Z(()=>T.loadDataFromGoogle()),await m,p(),T.accountBezeichnungen;const J=T.accountNames;let K=W(L.bookings),i=W(new et(v,J,K));i.findAccount("System","Errors");const s=_t();pt(n.$state,async(o,w)=>{await L.loadBussiData(n.currentPeriod),K=W(L.bookings),i=new et(v,J,K),i=Ft(i,K,f,n),i=N(i,K,f,n),i=R(i,K,f,n),s&&s.proxy&&s.proxy.$forceUpdate(),u.bookings=[],u.name=""});const c=()=>i.findAccount("Bussi","Kilometer").saldoY(n.currentPeriod),a=()=>Math.round(K.reduce((o,w)=>o+F(w),0)),y=()=>Math.round(100*a()*2.37/1e3)/100,h=()=>Math.round(a()/c()*1e4)/100,F=o=>q(o)?+o.liters.replace("l","").trim().replace(",","."):0;I("bs after bookEverythingtoBS",i);const N=(o,w,C,z)=>{const d=o.findAccount("Bussi","Konto 1"),_=Nt(-d.saldoY(z.currentPeriod)/C.personen.length);if(_===0)return o;for(var G of C.personen){const B=o.findAccount(G,"Konto 1"),M=new S("9999",z.currentPeriod+"-12-31",_,0,"Ausgleichsbuchung Konto1 "+z.currentPeriod+" "+B.owner+":"+B.name+" -> "+d.owner+":"+d.name);E(M,B,d)}return o},R=(o,w,C,z)=>{const d=o.saldierenEuro("Bussi"),_=C.personen.map(B=>{const M=o.saldierenEuro(B)+d/C.personen.length;return{name:B,saldo:M}});let G=100;for(;G-- >0;){const B=_.reduce((D,$)=>D.saldo<$.saldo?D:$),M=_.reduce((D,$)=>D.saldo>$.saldo?D:$);if(B.saldo>=0||M.saldo<=0)break;const V=Math.min(-B.saldo,M.saldo),j=o.findAccount(M.name,"Ausgleichskonto"),H=o.findAccount(B.name,"Ausgleichskonto"),ct="Ausgleichsbuchung Salden <br>"+z.currentPeriod+" "+j.owner+":"+j.name+" -> "+H.owner+":"+H.name+"<br>Amount: "+nt(V)+"<br>konkret:  "+j.owner+" bekommt "+nt(V)+" von "+H.owner,at=new S("9999",z.currentPeriod+"-12-31",V,0,ct);E(at,j,H),B.saldo+=V,M.saldo-=V}return o};return(o,w)=>{const C=Lt,z=vt;return k(),x("div",null,[b(C),r("h1",null,"Bilanz "+A(l(n).currentPeriod)+", "+A(l(K).length)+" Buchungen ",1),l(i).findAccount("Bussi","Errors").bookings.length>0?(k(),x("div",Mt,[r("a",{class:"errors",href:"#",onClick:w[0]||(w[0]=d=>t(l(i).findAccount("Bussi","Errors")))}," Errors: "+A(l(i).findAccount("Bussi","Errors").bookings.length),1)])):tt("",!0),r("div",null,"Kilometer: "+A(c())+" km",1),r("div",null,"Benzin: "+A(a())+" Liter",1),r("div",null,"CO2: "+A(y())+" Tonnen CO2 ",1),r("div",null,"Verbrauch: "+A(h())+" Liter/100km",1),r("div",null,"Reparaturpauschale: "+A(l(n).reparaturpauschale("2022"))+"€",1),Ot,u.bookings.length!=0?(k(),x("div",Rt,[r("div",Gt,[r("button",{class:"green",onClick:w[1]||(w[1]=d=>g())},"hit ⌘+<Enter> to go back"),u.bookings.length>0?(k(),x("div",It)):tt("",!0),b(z,{selectedBookingsToRender:u.bookings,konto:u.name},null,8,["selectedBookingsToRender","konto"])])])):(k(),x("div",Tt,[r("table",null,[(k(!0),x(Q,null,X(l(v),d=>(k(),x("tr",null,[r("td",null,[st(A(d),1),r("a",{href:"#",onClick:_=>t(l(i).findAccount(d,"Kilometer"))},[r("div",null,"Kilometer: "+A(Math.abs(l(i).findAccount(d,"Kilometer").saldoY(l(n).currentPeriod)))+" km",1)],8,Vt),r("div",null,[r("b",null,"Saldo: "+A(l(i).saldierenEuro(d))+" €",1)])]),r("td",null,[r("table",Dt,[$t,Yt,Ut,jt,(k(!0),x(Q,null,X(l(T).accounts.filter(_=>_.Name!=="Kilometer"&&(_.Name!=="Konto 9000"||d==="Bussi")),_=>(k(),x("tr",Ht,[r("td",Wt,[r("a",{href:"#",onClick:G=>t(l(i).findAccount(d,_.Name))},[r("span",null,A(_.Bezeichnung),1)],8,Zt),qt]),r("td",Jt,A(l(i).findAccount(d,_.Name).saldoY(l(n).currentPeriod)),1),r("td",Qt,A(l(i).findAccount(d,_.Name).saldoSoll(l(n).currentPeriod)),1),r("td",Xt,A(l(i).findAccount(d,_.Name).saldoHaben(l(n).currentPeriod)),1)]))),256))])])]))),256))])])),bt,te])}}});const ue=yt(ee,[["__scopeId","data-v-69cff240"]]);export{ue as default};
